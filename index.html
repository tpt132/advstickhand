<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Stickhandling Trainer</title>
  <style>
    body, html { margin:0; padding:0; height:100%; overflow:hidden; background:#000; color:#fff; }
    #video, #canvas { position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; }
    #ui { position:absolute; top:10px; left:10px; z-index:10; }
    button { font-size:18px; padding:8px 16px; margin-right:8px; }
    #status { margin-top:8px; font-size:24px; }
  </style>
</head>
<body>
  <div id="ui">
    <button onclick="start()">Start</button>
    <button onclick="stop()">Stop</button>
    <div id="status"></div>
  </div>
  <video id="video" autoplay muted playsinline></video>
  <canvas id="canvas"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@latest"></script>
  <script>
  let model, video, canvas, ctx;
  let targetZone = null, speaking = false;
  let zoneHit = false;

  async function start() {
    if (!model) {
      status('Loading model...');
      model = await cocoSsd.load();
      status('Model ready!');
    }
    video = document.getElementById('video');
    canvas = document.getElementById('canvas');
    ctx = canvas.getContext('2d');

    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;
    video.addEventListener('loadeddata', () => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      nextRound();
      requestAnimationFrame(detectLoop);
    });
  }

  function stop() {
    if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    status('');
    targetZone = null;
  }

  function status(msg) {
    document.getElementById('status').innerText = msg;
  }

  function say(text) {
    if (!speaking) {
      speaking = true;
      const u = new SpeechSynthesisUtterance(text);
      u.onend = () => speaking = false;
      speechSynthesis.speak(u);
    }
  }

  function nextRound() {
    zoneHit = false;
    targetZone = Math.floor(Math.random() * 9) + 1;
    status('Target: ' + targetZone);
    say(targetZone);
  }

  async function detectLoop() {
    if (!model || !video.srcObject) return;
    const preds = await model.detect(video);
    ctx.drawImage(video, 0, 0);

    // draw boxes
    preds.forEach(p => {
      if (p.class === 'sports ball' && p.score > 0.5) {
        const [x, y, w, h] = p.bbox;
        ctx.strokeStyle = 'lime';
        ctx.lineWidth = 4;
        ctx.strokeRect(x, y, w, h);
        const cx = x + w/2, cy = y + h/2;

        // map to grid 1â€“9
        const col = Math.floor(cx / canvas.width * 3);
        const row = Math.floor(cy / canvas.height * 3);
        const zone = row * 3 + col + 1;

        ctx.fillStyle = 'yellow';
        ctx.font = '30px Arial';
        ctx.fillText(zone, cx, cy - 10);

        if (!zoneHit && zone === targetZone) {
          zoneHit = true;
          say('Good');
          setTimeout(nextRound, 1000);
        }
      }
    });

    requestAnimationFrame(detectLoop);
  }
  </script>
</body>
</html>
